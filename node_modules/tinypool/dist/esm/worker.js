import{f as w,g as m,j as M,m as p,n as y}from"./chunk-NBICOIEE.js";import{parentPort as h,receiveMessageOnPort as _,workerData as b}from"worker_threads";import{pathToFileURL as T}from"url";process.__tinypool_state__={isWorkerThread:!0,workerData:b};var o=new Map,k=process.env.PISCINA_DISABLE_ATOMICS!=="1",d;function E(){return d===void 0&&(d=new Function("specifier","return import(specifier)")),d}async function A(t,s){let e=o.get(`${t}/${s}`);if(e!==void 0)return e;try{e=await import(t),typeof e!="function"&&(e=await e[s])}catch{}if(typeof e!="function"&&(e=await E()(T(t).href),typeof e!="function"&&(e=await e[s])),typeof e!="function")return null;if(o.size>1e3){let[[n]]=o;o.delete(n)}return o.set(`${t}/${s}`,e),e}h.on("message",t=>{k=process.env.PISCINA_DISABLE_ATOMICS==="1"?!1:t.useAtomics;let{port:s,sharedBuffer:e,filename:n,name:c}=t;(async function(){n!==null&&await A(n,c);let a={ready:!0};h.postMessage(a),s.on("message",P.bind(null,s,e)),S(s,e)})().catch(C)});var g=0,I=0;function S(t,s){if(!!k)for(;g===0;){Atomics.wait(s,p,I),I=Atomics.load(s,p);let e;for(;(e=_(t))!==void 0;)P(t,s,e.message)}}function P(t,s,e){g++;let{taskId:n,task:c,filename:a,name:R}=e;(async function(){let u,l=[];try{let i=await A(a,R);if(i===null)throw new Error(`No handler function exported from ${a}`);let r=await i(c);M(r)&&(l=l.concat(r[w]),r=r[m]),u={taskId:n,result:r,error:null},process.stdout.writableLength>0&&await new Promise(f=>process.stdout.write("",f)),process.stderr.writableLength>0&&await new Promise(f=>process.stderr.write("",f))}catch(i){u={taskId:n,result:null,error:i}}g--,t.postMessage(u,l),Atomics.add(s,y,1),S(t,s)})().catch(C)}function C(t){process.nextTick(()=>{throw t})}
